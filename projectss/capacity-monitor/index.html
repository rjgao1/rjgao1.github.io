<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Rooney Jingyuan Gao ">
<meta name="description" content="Code This open source project&amp;rsquo;s code is not available to the public lives here
Credits this amazing blog from pysource . this amazing blog from pyimagesearch .
example tensorflow usage from medium user @@madhawavidanapathirana .
pretrained models provided by this:
Description Our application: Our application detects and tracks humans from a live or recorded video feed, and keeps track of a counter for the number of times people enter and leave a space." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="#252627" />
<meta charset="utf-8">
<link rel="canonical" href="https://rjgao1.github.io/projectss/capacity-monitor/" />


    <title>
        
            Capacity Monitor :: Rooney Jingyuan Gao  â€” Rooney Jingyuan Gao
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="https://rjgao1.github.io/main.66e3d13c190326c58f973c2b2a4e491164033a3f5cdc7029d523518691808735.css">




    <link rel="apple-touch-icon" sizes="180x180" href="https://rjgao1.github.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://rjgao1.github.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://rjgao1.github.io/favicon-16x16.png">
    <link rel="manifest" href="https://rjgao1.github.io/site.webmanifest">
    <link rel="mask-icon" href="https://rjgao1.github.io/safari-pinned-tab.svg" color="#252627">
    <link rel="shortcut icon" href="https://rjgao1.github.io/favicon.ico">
    <meta name="msapplication-TileColor" content="#252627">
    <meta name="theme-color" content="#252627">



<meta itemprop="name" content="Capacity Monitor">
<meta itemprop="description" content="Code This open source project&rsquo;s code is not available to the public lives here
Credits this amazing blog from pysource . this amazing blog from pyimagesearch .
example tensorflow usage from medium user @@madhawavidanapathirana .
pretrained models provided by this:
Description Our application: Our application detects and tracks humans from a live or recorded video feed, and keeps track of a counter for the number of times people enter and leave a space.">
<meta itemprop="datePublished" content="2020-06-14T03:26:48-04:00" />
<meta itemprop="dateModified" content="2020-06-14T03:26:48-04:00" />
<meta itemprop="wordCount" content="1324">
<meta itemprop="image" content="https://rjgao1.github.io/"/>



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://rjgao1.github.io/"/>

<meta name="twitter:title" content="Capacity Monitor"/>
<meta name="twitter:description" content="Code This open source project&rsquo;s code is not available to the public lives here
Credits this amazing blog from pysource . this amazing blog from pyimagesearch .
example tensorflow usage from medium user @@madhawavidanapathirana .
pretrained models provided by this:
Description Our application: Our application detects and tracks humans from a live or recorded video feed, and keeps track of a counter for the number of times people enter and leave a space."/>



    <meta property="og:title" content="Capacity Monitor" />
<meta property="og:description" content="Code This open source project&rsquo;s code is not available to the public lives here
Credits this amazing blog from pysource . this amazing blog from pyimagesearch .
example tensorflow usage from medium user @@madhawavidanapathirana .
pretrained models provided by this:
Description Our application: Our application detects and tracks humans from a live or recorded video feed, and keeps track of a counter for the number of times people enter and leave a space." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://rjgao1.github.io/projectss/capacity-monitor/" />
<meta property="og:image" content="https://rjgao1.github.io/"/>
<meta property="article:published_time" content="2020-06-14T03:26:48-04:00" />
<meta property="article:modified_time" content="2020-06-14T03:26:48-04:00" />






    <meta property="article:published_time" content="2020-06-14 03:26:48 -0400 EDT" />








    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://rjgao1.github.io/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">$ cd /home/</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://rjgao1.github.io/education/">Education</a></li><li><a href="https://rjgao1.github.io/projects/">Projects</a></li><li><a href="https://rjgao1.github.io/work/">Work</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="https://rjgao1.github.io/projectss/capacity-monitor/">Capacity Monitor</a></h2>

            

            <div class="post-content">
                <h2 id="code">Code</h2>
<p>This open source project&rsquo;s code <del>is not available to the public</del> lives <a href="https://github.com/rjgao1/team-project-chalmer-s-cards/tree/master/d3">here</a></p>
<h2 id="credits">Credits</h2>
<p><a href="https://pysource.com/2019/07/08/yolo-real-time-detection-on-cpu/">this amazing blog from pysource</a> .
<a href="https://www.pyimagesearch.com/2018/08/13/opencv-people-counter/">this amazing blog from pyimagesearch</a> .</p>
<p><a href="https://medium.com/@madhawavidanapathirana/real-time-human-detection-in-computer-vision-part-2-c7eda27115c6">example tensorflow usage from medium user @@madhawavidanapathirana</a> .</p>
<p><a href="https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/detection_model_zoo.md#coco-trained-models-coco-models">pretrained models provided by this:</a></p>
<h2 id="description">Description</h2>
<p>Our application: Our application detects and tracks humans from a live or recorded video feed, and keeps track of a counter for the number of times people enter and leave a space.  From an end-user&rsquo;s perspective, our application will be used for counting the number of people coming in and out of a homeless shelter.  This information can then be used to keep track of the occupancy of a shelter by taking the difference of those two figures.  This will be used to ensure that the number of people in a homeless shelter do not go over the fire occupancy limit.</p>
<p>Context: Part of a homeless shelters requirements is to always keep track of the occupancy of the building to keep the number of people within fire code specifications. When a shelter reaches full capacity, clients who unfortunately seek refuge in these shelters need to be deferred to another which is the problem we are trying to solve with this project.  This project looks to aid the shelter referral process by providing a simple solution; a counter that streamlines the process of counting the flow of people in and out of a building. This information is then readily available to other shelters so clients can be referred to shelters with vacancy quickly.  The objective of this project to ensure everyone has a hot meal and a place to sleep on a cold night.</p>
<p>Value: Currently, there is a system in place that does keep track of the occupancy of homeless shelters, but it is insanely slow and inaccurate.  The aim of our application is to improve upon this system and ensure that occupancy counts are accurate, and real-time, as to ensure that everyone is referred quickly to a free shelter.</p>
<h2 id="key-features">Key Features</h2>
<p><em><strong>Highly parametrized</strong></em><br>
This command-line software has parametrized options:<br>
object detection framework (OpenCV and Tensorflow)<br>
pre-trained model and prototxt<br>
input source: laptop webcam, Real-Time Streaming Protocol and video file,<br>
output file<br>
confidece treshold for detection<br>
skip-frame for detection frequency<br>
overlay display: on/off.</p>
<p><em><strong>Support of Real-Time Streaming Protocol</strong></em><br>
Our software supports an RTSP stream produced by an IP camera falshed with DaFang Hacks. This allows multiple instances to run and process from the same video stream at the same time; since the detection frameworks are parametrized, these running instances can run different frameworks. For example, this enables clients to have multiple machines monitoring the same homeless shelter.</p>
<p>Depending on the feature of the IP camera, the support of RTSP allows clients to process video streams produced by different configurations of the IP camera. For example, client can configure their IP camera to produce infrared video streams and process it with our software.</p>
<p><em><strong>Support of video file input</strong></em><br>
When IP camera video streams are not available, which could very likely be the case in many homeless shelters, our software can take a video file (.MOV, .mp4 or .avi) as its input and process as usual. This can also provide valuable insights by running on footage generated prior to the installation of our software to study the effectiveness and progress.</p>
<p><em><strong>Customizable models and detection frameworks</strong></em><br>
Our software don&rsquo;t depend on a single pre-trained model. Client can select different models (caffemodel for OpenCV framework and protobuf for Tensorflow) and have our software utilize.<br>
It also supports two object detection frameworks: client can choose between using OpenCV to perform a forward pass on the model and using Tensorflow. This gives client better flexibility when access to appropriate models is limited.</p>
<p><em><strong>Performance</strong></em><br>
With the default models our software uses, it is lightweight and fast. MobileNet is designed to be run on resource-limited mobile devices. In our expeirence, when processing RTSP streams, our model yields 29-31+ FPS (which is very close to being sufficient for real-time processing) when using the OpenCV for detection and 15+ FPS when using Tensorflow for detection.</p>
<h2 id="demo">Demo</h2>
<p>MobileNet tracking test: note that this is not an ideal environment.<br>
I&rsquo;m surprised that the program didn&rsquo;t pick up my reflections.</p>
<p><img src="../../cvtest.gif" alt="demo"></p>
<p>Comparison between tensorflow framework and Open CV with mobilenet framework.</p>
<p>Tensorflow mobilenet:</p>
<p><img src="../../tensorflow.gif" alt="tensorflow"></p>
<p>MobileNet:</p>
<p><img src="../../opencv.gif" alt="openCV"></p>
<h2 id="instructions-assuming-python-3-is-installed">Instructions (assuming python 3 is installed)</h2>
<p>clone the repo:
<code>git clone https://github.com/csc301-fall-2019/team-project-chalmer-s-cards.git</code>
create and activate your virtual environment:</p>
<pre><code>cd team-project-chalmer-s-cards
python3 -m venv .venv
source ./.venv/bin/activate
</code></pre><p>go the group 2 directory:
<code>cd team-project-chalmer-s-cards/d3/occupancyCounter</code></p>
<p>Download dependencies:<br>
<code>pip install -requirement requirement</code> or alternatively <code>pip install tensorflow dlib imutils numpy opencv-python scipy</code></p>
<p>run <code>people_counter.py</code> with the required arguments (this step will open the default webcam on your laptop. Default object detection framework is with OpenCV. OpenCV requires a prototxt.):</p>
<pre><code>python3 people_counter.py --prototxt mobilenet_ssd/MobileNetSSD_deploy.prototxt \
--model mobilenet_ssd/MobileNetSSD_deploy.caffemodel
</code></pre><p>To save the output video, add the &ndash;output flag:</p>
<pre><code>python3 people_counter.py --prototxt mobilenet_ssd/MobileNetSSD_deploy.prototxt \
--model mobilenet_ssd/MobileNetSSD_deploy.caffemodel \
--output &lt;your_output_video.avi&gt;
</code></pre><p>To use a video file instead of your webcam, add the <code>--input</code> flag, it supports .MOV, .mp4 and .avi:</p>
<pre><code>python3 people_counter.py --prototxt mobilenet_ssd/MobileNetSSD_deploy.prototxt --model \
mobilenet_ssd/MobileNetSSD_deploy.caffemodel \
--input &lt;you_input_video.avi&gt; --output &lt;your_output_video.avi&gt;
</code></pre><p>To use the tensorflow detection framework, add the &ndash;detectfw flag:</p>
<pre><code>python3 people_counter.py --model tfmobilenet/frozen_inference_graph.pb \
--detectfw tensorflow
</code></pre><p>Other optional flags:<br>
<code>--confidence</code> or <code>-c</code>: default=0.5, float, minimum confidence level for detection</p>
<p><code>--skip-frames</code> or <code>-s</code>: default=30, int, number of frames to skip between detections. The program will only detect at frame numers that are multiples of <code>skip-frames</code>.
<code>--hieedisplay</code> or <code>-hd</code>: default action=store_true. Normally displays overlay for trackers. If you add this flag(with no arguments) there will be no overlay.</p>
<h2 id="program-workflow">Program Workflow</h2>
<p>This program detects and tracks human from a live or recorded video feed, and keeps track of a counter for the number of times people enter and leave a space.</p>
<p>The program has 3 states.
<em><strong>Wating</strong></em>
When there are no existing objects and not detecting, the program is simply in the waiting state, not doing computations.</p>
<p><em><strong>Detecting:</strong></em>
When the frame number is a multiple of the <code>skip-frames</code> parameters, the program detects human only, using MobileNet with OpenCV or Tensorflow depending on command line input.</p>
<p><em><strong>Tracking:</strong></em>
When there are existing obejcts, the program uses centroids for tracking. After detecting the object and determining a bounding box, it finds the centroid of the bounding box and uses the coordinates of it for tracking. We are currently using the simple centroid tracking module implemented by the <a href="www.pyimagesearch.com">pyimagesearch blog</a>.</p>
<p><em><strong>Algorithm for centroid tracking:</strong></em>
After determining bounding boxes, it calculates the centroid for each box. It then calculates the Euclidean distance between every pair of centroids. The assumption is that pairs with the smallest Euclidean distances must be the same obejct. For every existing centroid, it assigns its object ID to its 1 nearest neighbor. If there is any centroid that is 1) not an existing object, and 2) not a 1 nearest neighbor to any existing centroid, then it will be registered as a new object and added to the list of existing centroids.</p>
<p><img src="https://s3-us-west-2.amazonaws.com/static.pyimagesearch.com/people-counting/opencv_people_counter_centroid_tracking.gif" alt="centroid tracking gif"> (<a href="https://www.pyimagesearch.com/2018/08/13/opencv-people-counter/">credit</a>)</p>
<p>It works fairly well when the data is not noisy. For example, simple lightning condition (no shadow) and movements (less people, straighforward movements).</p>
<p>It uses a combination of walking direction and position to determine if a centroid has entered or left a space. Essentially, when the direction is toward the exit of a space and the position of the centroid is on the outside of the exit, then the centroid is considered as &ldquo;left&rdquo;. Similarly, the the direction is the opposite of the exit of a space and the position of the centroid is on the inside of the exit, then the cnetroid is considered as &ldquo;left&rdquo;.</p>
<p>To save computation and achieve a higher processing FPS (frames per second), it counts every object once, when they are in frame. It can made the program more prone to errors when the movements get complicated. For example, when a person corsses the exit but re-enters while still in frame, the program will not capture the re-enter as it has counted the person.</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
  		</div>
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2020</span>
            
                <span><a href="https://rjgao1.github.io/">Rooney Jingyuan Gao</a></span>
            
            
            
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Theme by <a href="https://github.com/rhazdon">Djordje Atlialp</a></span>
        </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="https://rjgao1.github.io/bundle.min.dc716e9092c9820b77f96da294d0120aeeb189b5bcea9752309ebea27fd53bbe6b13cffb2aca8ecf32525647ceb7001f76091de4199ac5a3caa432c070247f5b.js" integrity="sha512-3HFukJLJggt3&#43;W2ilNASCu6xibW86pdSMJ6&#43;on/VO75rE8/7KsqOzzJSVkfOtwAfdgkd5BmaxaPKpDLAcCR/Ww=="></script>



    </body>
</html>
